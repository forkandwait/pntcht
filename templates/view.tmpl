<!DOCTYPE html>

<html>

  <head>
	<title>View facilities</title>
	<!-- Changed by: , 28-Jul-2010 -->
	
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<link type="text/css" rel="stylesheet" href="/stylesheets/main.css" />

	<script src="http://maps.google.com/maps/api/js?sensor=false" type="text/javascript"></script>
	<script src="http://code.jquery.com/jquery-1.4.2.js" type="text/javascript"></script>

	<!-- viewing javascript functions -->
	<script type="text/javascript" src="/js/view.js"></script>
    
	<script type="text/javascript">
	  FACILITIES_MODEL = {};
	  INST_NAME = "{{ inst_name }}";
	  UNGUESSABLE_ID = "{{ unguessable_id }}";
	  var MAP;
	  
	  function make_map(fmodel, gmap) {
	        // TODO -- make this grab from a KML feed rather than generated code (blech!) 

		gmap = new google.maps.Map(document.getElementById("map_canvas"), {mapTypeId: google.maps.MapTypeId.ROADMAP});

		// Facilities markers -- generate a bunch of JS 
		//    via django template loop, store array globally.
		var name = "";
		var myLatLong = "";
		var marker = "";
		var bounds = new google.maps.LatLngBounds();
		{% for bldg in bldg_table %}
		        make_point("{{ bldg.name }}", {{ bldg.pt }}, gmap, bounds, fmodel);  // XXX bldg.pt expands 
		{% endfor %}

		// Zoom
		gmap.setCenter(bounds.getCenter());
		gmap.setZoom(14); 
          }

	</script>
  </head>

  <body onload="make_map(FACILITIES_MODEL, MAP); $('#comment_input').val('Map update');">

  <p> Buildings in facility <b>"{{ inst_name }}"</b> (reload to see changes): </p>
	
	<table id="point_table" border="1">
	  <tr><th> Building Name </th><th>Latitude</th><th>Longitude</th></tr>
	  {% for bldg in bldg_table %}
	    <tr  id="{{ bldg.name }}">
	      <td id="bldg_name"> {{ bldg.name }} </td> <td id="bldg_lat"> {{ bldg.pt.lat }} </td> <td id="bldg_lon"> {{ bldg.pt.lon }} </td>
	    </tr>
	  {% endfor %}
	</table>

	<hr>
	<p>Comment on this change: <input id="comment_input" type="text"/> </p>

	<hr>
	<table id="comment_table" border="1">
	  <tr><th> Change Message </th><th>Timestamp</th><th>User</th></tr>
	  {% for comm in comments %}
	    <tr class="comment_row" id="rownum{{forloop.counter}}">
	      <td> {{ comm.msg }} </td>
	      <td> {{ comm.timestamp }}</td>
	      <td> {{ comm.user }} </td>
	    </tr>
          {% endfor %}
	</table>

	<input onclick="updateFacilities(FACILITIES_MODEL, UNGUESSABLE_ID, $('#comment_input').val());" type=button value="Update"/>
		
	<hr>
	<div id="map_canvas" style="width: 450px; height: 350px"></div>	

  </body>
</html>
